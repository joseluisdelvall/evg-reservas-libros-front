<div class="container-fluid p-4">
    <!-- Elimino el spinner de carga global -->
    <div class="row">
        <!-- Columna de Lista de Editoriales -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-building me-2"></i>Editoriales con Pedidos</h5>
                </div>
                <div class="card-body">
                    <!-- Buscador de editoriales -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Buscar editorial..." 
                                [(ngModel)]="busquedaEditorial"
                                (ngModelChange)="filtrarEditoriales()">
                        </div>
                        <small class="text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            Buscar por nombre de editorial
                        </small>
                    </div>

                    <!-- Lista de editoriales -->
                    <div class="editorial-list">
                        <div *ngFor="let editorial of editorialesFiltradas" 
                             class="editorial-item"
                             [class.selected]="editorialSeleccionada?.idEditorial === editorial.idEditorial"
                             (click)="seleccionarEditorial(editorial)">
                            <h6 class="mb-1">{{ editorial.nombre }}</h6>
                            <div class="mt-2">
                                <span class="badge bg-info">
                                    {{ getPedidosPorEditorial(editorial.idEditorial || '') }} pedido(s)
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje si no hay editoriales -->
                    <div *ngIf="editorialesFiltradas.length === 0 && !editorialSeleccionada" class="text-center my-4 text-muted">
                        <i class="fas fa-building fa-2x mb-3"></i>
                        <p>No se encontraron editoriales con pedidos.</p>
                    </div>

                    <!-- Editorial seleccionada -->
                    <div *ngIf="editorialSeleccionada" class="mt-4">
                        <h6>Editorial Seleccionada:</h6>
                        <div class="alert alert-info">
                            <strong>{{ editorialSeleccionada.nombre }}</strong>
                        </div>
                    
                        <!-- Indicador de pedido seleccionado -->
                        <div class="mt-3 alert" 
                             [ngClass]="{'alert-success': pedidoSeleccionado && pedidoSeleccionado.idEditorial === editorialSeleccionada.idEditorial, 
                                         'alert-warning': !pedidoSeleccionado || (pedidoSeleccionado && pedidoSeleccionado.idEditorial !== editorialSeleccionada.idEditorial)}">
                            <i class="fas me-2" 
                               [ngClass]="{'fa-check-circle': pedidoSeleccionado && pedidoSeleccionado.idEditorial === editorialSeleccionada.idEditorial, 
                                           'fa-info-circle': !pedidoSeleccionado || (pedidoSeleccionado && pedidoSeleccionado.idEditorial !== editorialSeleccionada.idEditorial)}"></i>
                            <span *ngIf="pedidoSeleccionado && pedidoSeleccionado.idEditorial === editorialSeleccionada.idEditorial">
                                <strong>1 pedido</strong> seleccionado (ID: #{{ pedidoSeleccionado.idPedido }})
                            </span>
                            <span *ngIf="!pedidoSeleccionado || (pedidoSeleccionado && pedidoSeleccionado.idEditorial !== editorialSeleccionada.idEditorial)">
                                No hay pedidos seleccionados de esta editorial
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna de Pedidos de la Editorial -->
        <div class="col-md-8">
            <div class="card shadow-sm w-100" [class.disabled]="!editorialSeleccionada">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>Pedidos realizados de 
                        <span>{{ editorialSeleccionada ? editorialSeleccionada.nombre : '...' }}</span>
                    </h5>
                    <button *ngIf="editorialSeleccionada" 
                            class="btn btn-sm btn-light" 
                            (click)="limpiarSeleccion()" 
                            title="Cerrar Pedidos">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Spinner de carga para pedidos -->
                    <div *ngIf="isLoading || isLoadingDetalles" class="d-flex justify-content-center my-4 align-items-center">
                        <div class="spinner-border" style="color: #0d6efd;" role="status">
                            <span class="visually-hidden">Cargando pedidos realizados...</span>
                        </div>
                        <span class="ms-2">Cargando pedidos realizados...</span>
                    </div>
                    <!-- Mensaje cuando no hay editorial seleccionada -->
                    <div *ngIf="!editorialSeleccionada && !isLoadingDetalles && !isLoading" class="text-center my-5 text-muted">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <p>Selecciona una editorial para ver sus pedidos</p>
                    </div>
                    <!-- Lista de pedidos de la editorial -->
                    <div *ngIf="editorialSeleccionada && !isLoadingDetalles && !isLoading">
                        <!-- Buscador de pedidos -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    placeholder="Buscar pedido..." 
                                    [(ngModel)]="busquedaPedido"
                                    (ngModelChange)="filtrarPedidosPorEditorial()">
                            </div>
                            <small class="text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>
                                Buscar por ID o fecha
                            </small>
                        </div>

                        <!-- Lista de pedidos -->
                        <div class="pedido-list">
                            <p class="mb-3"><small class="text-muted">Mostrando {{ pedidosFiltrados.length }} de {{ pedidos.length }} pedidos realizados</small></p>
                            <div *ngFor="let pedido of pedidosFiltrados" 
                                 class="pedido-item"
                                 [class.selected]="pedidoSeleccionado?.idPedido === pedido.idPedido"
                                 (click)="seleccionarPedido(pedido)"
                                 data-bs-toggle="modal" 
                                 [attr.data-bs-target]="'#' + modalOptions.modalId">
                                <h6 class="mb-1">Pedido #{{ pedido.idPedido }}</h6>
                                <div class="mt-2">
                                    <small class="d-block text-muted">
                                        <i class="fas fa-calendar-alt me-1"></i>{{ pedido.fecha | date:'dd/MM/yyyy' }}
                                    </small>
                                    <div class="mt-2">
                                        <span class="badge bg-info me-2">
                                            {{ pedido.numLibros || 0 }} libro(s)
                                        </span>
                                        <span class="badge" [ngClass]="getEstadoBadgeClass(pedido.estado || '')">
                                            {{ getEstadoTexto(pedido.estado || '') }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje si no hay pedidos -->
                        <div *ngIf="pedidosFiltrados.length === 0" class="text-center my-4 text-muted">
                            <i class="fas fa-box-open fa-2x mb-3"></i>
                            <p>No se encontraron pedidos para esta editorial.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalles del Pedido -->
<app-modal-content [options]="modalOptions" (okButtonClicked)="confirmarRecepcionPedido()">
    <div *ngIf="pedidoSeleccionado">
        <!-- InformaciÃ³n general del pedido -->
        <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
                <div class="info-item">
                    <p class="mb-0 d-flex align-items-center">
                        <i class="fas fa-building me-2"></i>
                        <strong class="me-2">Editorial:</strong>
                        <span>{{ pedidoSeleccionado.editorial?.nombre || 'N/A' }}</span>
                    </p>
                </div>
                <div class="info-item text-center">
                    <p class="mb-0 d-flex align-items-center">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <strong class="me-2">Fecha:</strong>
                        <span>{{ pedidoSeleccionado.fecha | date:'dd/MM/yyyy' }}</span>
                    </p>
                </div>
                <div class="info-item text-end">
                    <p class="mb-0 d-flex align-items-center">
                        <i class="fas fa-book me-2"></i>
                        <strong class="me-2">Total de libros:</strong>
                        <span>{{ pedidoSeleccionado.numLibros || 0 }}</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Tabla de libros del pedido -->
        <div class="table-responsive mt-4">
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Libro</th>
                        <th>ISBN</th>
                        <th class="text-center" style="width: 10%;">Cant. Pedido</th>
                        <th class="text-center" style="width: 15%;">Cant. Ya Recibida</th>
                        <th class="text-center" style="width: 12%;">Cant. Restante</th>
                        <th class="text-center" style="width: 12%;">Cant. Recibida</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of pedidoSeleccionado.librosPedido; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td>{{ item.libro?.nombre || 'Nombre no disponible' }}</td>
                        <td>{{ item.libro?.isbn || 'N/A' }}</td>
                        <td class="text-center">{{ item.unidades }}</td>
                        <td class="text-center">{{ item.unidadesRecibidas || 0 }}</td>
                        <td class="text-center">{{ item.unidades - (item.unidadesRecibidas || 0) }}</td>
                        <td class="text-center">
                            <input 
                                type="number" 
                                class="form-control form-control-sm text-center w-75 mx-auto" 
                                [value]="0"
                                [max]="item.unidades - (item.unidadesRecibidas || 0)"
                                min="0"
                                (input)="handleUnidadesRecibidasChange(item, $event)"
                                [disabled]="pedidoSeleccionado.estadoPedido === 'Entregado' || (item.unidadesRecibidas || 0) >= item.unidades">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</app-modal-content>
