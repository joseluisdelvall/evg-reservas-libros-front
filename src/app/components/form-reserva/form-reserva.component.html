<div class="container py-5">
    <div class="row align-items-center mb-4">
        <div class="col-2">
            <a href="https://fundacionloyola.com/vguadalupe/" class="btn btn-outline-secondary rounded-pill">
                <i class="fas fa-arrow-left fa-sm me-2"></i>
                <span class="d-none d-md-inline">Volver</span>
            </a>
        </div>
        <div class="col-8 text-center">
            <h2 class="mb-0 text-primary fw-bold">Reserva de Libros EVG</h2>
        </div>
    </div>

    <!-- Indicador de carga mientras se verifica el periodo -->
    <div *ngIf="verificandoPeriodo" class="row justify-content-center">
        <div class="col-md-8 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Verificando periodo de reservas...</p>
        </div>
    </div>

    <!-- Mensaje cuando no está activo el periodo de reservas -->
    <div *ngIf="!verificandoPeriodo && !periodoReservasActivo" class="row justify-content-center">
        <div class="col-md-8">
            <div class="alert alert-info shadow-lg p-4 text-center">
                <i class="fas fa-calendar-alt fa-3x mb-3 text-primary"></i>
                <h4 class="alert-heading">Periodo de Reservas no Disponible</h4>
                <p>{{ mensajePeriodo }}</p>
                <hr>
                <p class="mb-0">Para más información, contacte con la secretaría del centro.</p>
            </div>
        </div>
    </div>

    <!-- Contenido del formulario (solo se muestra durante el periodo de reservas) -->
    <div class="row justify-content-center" *ngIf="!verificandoPeriodo && periodoReservasActivo">
        <!-- Card de Información Importante -->
        <div class="col-lg-3 col-md-6 col-12 mb-4">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-4">
                    <h6 class="card-title fw-bold text-secondary mb-3">
                        <i class="fas fa-info-circle me-2"></i> Información Importante
                    </h6>
                    <ul class="list-unstyled small text-muted">
                        <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i> Revisa cuidadosamente los datos del alumno antes de enviar.
                        </li>
                        <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i> Asegurate de que el correo electrónico y DNI sean correctos para futuras comunicaciones.	
                        </li>
                        <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i> Es necesario adjuntar el justificante de pago para completar la reserva.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Detalles de la reserva completada (aparecerá al lado cuando haya una reserva) -->
        <div class="col-lg-9 col-md-6 col-12 mb-4" *ngIf="reservaCompletada">
            <div class="card border-0 shadow-lg h-100">
                <div class="card-body p-4">
                    <h5 class="text-primary mb-3">Detalles de la Reserva #{{ reservaCompletada.idReserva }}</h5>
                    
                    <div class="mb-3">
                        <p class="mb-1"><strong>Nombre:</strong> {{ reservaCompletada.nombreAlumno || 'No especificado' }} {{ reservaCompletada.apellidosAlumno || '' }}</p>
                        <p class="mb-1"><strong>Correo:</strong> {{ reservaCompletada.correo || 'No especificado' }}</p>
                        <p class="mb-1"><strong>Fecha:</strong> {{ reservaCompletada.fecha || 'No especificada' }}</p>
                        <p class="mb-1"><strong>Estado:</strong> {{ reservaCompletada.verificado ? 'Verificado' : 'Pendiente de verificación' }}</p>
                        <p class="mb-1"><strong>Curso:</strong> {{ getCursoNombre(reservaCompletada.curso.idCurso) }}</p>
                    </div>
                    
                    <h6 class="text-secondary mb-2">Libros reservados:</h6>
                    <div class="table-responsive" *ngIf="reservaCompletada.libros && reservaCompletada.libros.length > 0">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let libro of reservaCompletada.libros">
                                    <td>{{ libro.nombre || 'No especificado' }}</td>
                                    <td>{{ libro.precio || '0.00' }}€</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>Total</th>
                                    <th>{{ calcularTotal(reservaCompletada.libros) }}€</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        <p class="small text-muted" *ngIf="reservaCompletada.idReserva < 1000">
                            Se ha enviado un correo de confirmación a {{ reservaCompletada.correo || 'tu correo' }}
                        </p>
                        <p class="small text-muted text-warning" *ngIf="reservaCompletada.idReserva >= 1000">
                            <i class="fas fa-exclamation-circle me-1"></i> No se pudo enviar el correo de confirmación. Por favor, guarde el número de reserva.
                        </p>
                        <button type="button" class="btn btn-sm btn-outline-primary" (click)="nuevaReserva()">
                            <i class="fas fa-plus-circle me-2"></i>Realizar nueva reserva
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario principal -->
        <div class="col-lg-9 col-md-8 col-12" *ngIf="!reservaCompletada">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-4">
                    <form [formGroup]="reservaForm" (ngSubmit)="onSubmit()">
                        <h6 class="mb-3 mt-4 text-muted">Selección de Libros</h6>
                        <div class="mb-3">
                            <label for="curso" class="form-label fw-semibold small text-muted">Curso (Selecciona el curso para ver los libros disponibles, puedes seleccionar varios libros)</label>
                            <ng-select
                                [items]="cursos"
                                formControlName="curso"
                                id="curso"
                                [multiple]="false"
                                [closeOnSelect]="true"
                                [searchable]="true"
                                bindLabel="nombre"
                                bindValue="id"
                                placeholder="Seleccione un curso"
                                class="ng-select-sm">
                            </ng-select>
                            <div *ngIf="isInvalid('curso')" class="text-danger small">{{ getError('curso') }}</div>
                        </div>

                        <div class="mb-3" *ngIf="mostrarLibros">
                            <label class="form-label fw-semibold small text-muted">Libro(s)*</label>
                            <div *ngIf="(!libros || libros.length === 0) && !loading" class="alert alert-sm alert-warning">
                                No hay libros disponibles para este curso.
                            </div>
                            <div *ngIf="libros && libros.length > 0" class="checkbox-list-container border rounded p-3">
                                <div *ngFor="let libro of libros; let i = index" class="form-check mb-2">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           [value]="libro.id" 
                                           [id]="'libro_' + i"
                                           (change)="onLibroCheckboxChange($event, libro.id!)"
                                           [checked]="isLibroSeleccionado(libro.id!)">
                                    <label class="form-check-label small" [for]="'libro_' + i">
                                        <strong>{{ libro.nombre }}</strong> ({{ libro.precio }}€)
                                        <br>
                                        <small class="text-muted">ISBN: {{ libro.isbn }} | Editorial: {{ libro.editorial?.nombre }}</small>
                                    </label>
                                </div>
                            </div>
                            <div *ngIf="isInvalid('librosSeleccionados')" class="text-danger small mt-1">{{ getError('librosSeleccionados') }}</div>
                            
                            <!-- Mostrar Total a Pagar -->
                            <div *ngIf="librosSeleccionados && librosSeleccionados.length > 0 && mostrarLibros" class="mt-3 pt-2 border-top">
                                <h6 class="fw-bold text-primary">Total a pagar: {{ totalAPagar | currency:'EUR':'symbol':'1.2-2' }}</h6>
                            </div>
                        </div>

                        <h6 class="mb-3 text-muted">Datos del Alumno</h6>
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="nombreAlumno" class="form-label fw-semibold small text-muted">Nombre del Alumno*</label>
                                <input type="text" id="nombreAlumno" class="form-control form-control-sm" formControlName="nombreAlumno" placeholder="Ingrese el nombre del alumno">
                                <div *ngIf="isInvalid('nombreAlumno')" class="text-danger small">{{ getError('nombreAlumno') }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="apellidosAlumno" class="form-label fw-semibold small text-muted">Apellidos del Alumno*</label>
                                <input type="text" id="apellidosAlumno" class="form-control form-control-sm" formControlName="apellidosAlumno" placeholder="Ingrese los apellidos del alumno">
                                <div *ngIf="isInvalid('apellidosAlumno')" class="text-danger small">{{ getError('apellidosAlumno') }}</div>
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4 text-muted">Información del Tutor (Obligatoria únicamente para reservas de Infantil)</h6>
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="nombreTutor" class="form-label fw-semibold small text-muted">Padre / Madre / Tutor Legal</label>
                                <input type="text" id="nombreTutor" class="form-control form-control-sm" formControlName="nombreTutor" placeholder="Ingrese el nombre del tutor">
                                <div *ngIf="isInvalid('nombreTutor')" class="text-danger small">{{ getError('nombreTutor') }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="apellidosTutor" class="form-label fw-semibold small text-muted">Apellidos del Tutor Legal</label>
                                <input type="text" id="apellidosTutor" class="form-control form-control-sm" formControlName="apellidosTutor" placeholder="Ingrese los apellidos del tutor">
                                <div *ngIf="isInvalid('apellidosTutor')" class="text-danger small">{{ getError('apellidosTutor') }}</div>
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4 text-muted">Datos de Contacto (Asegúrate de que sean correctos para futuras comunicaciones)</h6>
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="dni" class="form-label fw-semibold small text-muted">DNI*</label>
                                <input type="text" id="dni" class="form-control form-control-sm" formControlName="dni" placeholder="Ingrese el DNI">
                                <div *ngIf="isInvalid('dni')" class="text-danger small">{{ getError('dni') }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="correo" class="form-label fw-semibold small text-muted">Correo Electrónico*</label>
                                <input type="email" id="correo" class="form-control form-control-sm" formControlName="correo" placeholder="Ingrese el correo electrónico">
                                <div *ngIf="isInvalid('correo')" class="text-danger small">{{ getError('correo') }}</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="telefono" class="form-label fw-semibold small text-muted">Teléfono de Contacto*</label>
                            <input type="tel" id="telefono" class="form-control form-control-sm" formControlName="telefono" placeholder="Ingrese el teléfono">
                            <div *ngIf="isInvalid('telefono')" class="text-danger small">{{ getError('telefono') }}</div>
                        </div>

                        <h6 class="mb-3 mt-4 text-muted">Justificante de Pago (Es necesario adjuntar el justificante para completar la reserva)</h6>
                        <!-- IBAN en un alert de Bootstrap -->
                        <div class="mb-3">
                            <div class="alert alert-info mb-0" role="alert">
                                <strong>Cuenta para realizar el ingreso (IBAN):</strong>
                                <span class="fw-bold ms-2">ES73 0182 5566 7402 0152 1854</span><br>
                                <span class="small">Realice el ingreso o transferencia a este número de cuenta antes de adjuntar el justificante.</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="justificante" class="form-label fw-semibold small text-muted">Subir Justificante*</label>
                            <input type="file" id="justificante" class="form-control form-control-sm" (change)="onFileChange($event)" accept=".pdf,.jpg,.jpeg,.png">
                            <div class="form-text small text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>
                                Solo se permiten archivos PDF e imágenes (JPG, PNG). Tamaño máximo: 5MB
                            </div>
                            <div *ngIf="!justificanteFile && reservaForm.get('justificante')?.touched" class="text-danger small">Este campo es obligatorio.</div>
                        </div>

                        <!-- Esta es la sección del botón de envío, que debe estar dentro del formulario -->
                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary rounded-pill px-4 py-2" [disabled]="loading">
                                <i class="fas fa-paper-plane me-2"></i> {{ loading ? 'Enviando...' : 'Realizar Reserva' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mt-4">
        <div class="col-12 text-center">
            <div>joseluisdelvall</div>
            <div>merroji</div>
            <div>asanchezEVG</div>
        </div>
    </div>
</div>